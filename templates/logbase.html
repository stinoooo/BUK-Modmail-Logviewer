<!DOCTYPE html>
<html lang="en">

<head>
    <title>Log Entry</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

    <meta content="{{ log_entry.thread_messages | length }} messages {% if log_entry.open %}(Open){% else %}(Closed){% endif %}" property="og:site_name">
    <meta content="Recipient: {{ log_entry.recipient | string | e }}" property="og:title">
    <meta content='{{ log_entry.recipient.avatar_url }}' property='og:image'>
    <meta content='Created {{ log_entry.human_created_at }}' property='og:image'>

    <link rel="shortcut icon" href="/static/favicon.ico">
    <link rel="stylesheet" href="/static/css/solarized-dark.css">
    <link rel="stylesheet" href="/static/css/logstyle.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/materialize.css" media="screen,projection">
    <link href="/static/css/style.css" type="text/css" rel="stylesheet" media="screen,projection">
    <link href="/static/css/animate.min.css" type="text/css" rel="stylesheet" media="screen,projection">
    <link href="https://fonts.googleapis.com/css?family=Bowlby+One+SC" rel="stylesheet">

    <script src="/static/js/highlight.pack.js"></script>
    <script src="/static/js/jquery-3.3.1.min.js"></script>
</head>

<body>

    {% block navbar %}
        {% include 'navbar.html' %}
    {% endblock %}
    
    <!-- Main Log Entry Section -->
    <div class="container">
        <div class="row entry">
            <!-- Recipient and Thread Info -->
            <div class="col s12 m12 l3">
                <div class="card-panel hoverable">
                    <div class="info__guild-icon-container">
                        <img class="info__guild-icon hoverable" 
                             src="{{ log_entry.recipient.avatar_url }}"
                             onerror="this.src='{{ log_entry.recipient.default_avatar_url }}'" 
                             alt="Recipient Avatar">
                    </div>
                    <div class="info__metadata">
                        <h5 style="color: white;">Thread Logs</h5>
                        <p>{% if log_entry.open %}(Open){% else %}(Closed){% endif %}</p>
                        <p><strong>Recipient:</strong> <span style="color: white">{{ log_entry.recipient.name | e }}</span>#{{ log_entry.recipient.discriminator }}</p>
                        {% if log_entry.recipient != log_entry.creator %}
                        <p><strong>Creator:</strong> <span style="color: white">{{ log_entry.creator.name | e }}</span>#{{ log_entry.creator.discriminator }}</p>
                        {% endif %}
                        <p><strong>{{ log_entry.thread_messages | length }} messages</strong></p>

                        <!-- Internal Toggle -->
                        {% if log_entry.internal_messages %}
                        <div class="switch" style="text-align: right;">
                            <label>
                                View Internal
                                <input id="internal_toggle" type="checkbox" onclick="toggleInternalMessages()">
                                <span class="lever"></span>
                            </label>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Chat Logs -->
            <div class="col s12 m12 l9">
                <div class="card-panel hoverable chatlog">
                    {% for group in log_entry.message_groups %}
                    <div class="{{ group.type }} chatlog__message-group" onclick="hoverIt(this)">
                        <div class="chatlog__author-avatar-container">
                            <img class="chatlog__author-avatar" 
                                 src="{{ group.author.avatar_url }}" 
                                 onerror="this.src='{{ group.author.default_avatar_url }}'"
                                 alt="Author Avatar"/>
                        </div>
                        <div class="chatlog__messages">
                            <span class="chatlog__author-name">{{ group.author.name | e }}</span>
                            {% if group.type == 'thread_message' and group.author.mod %}
                            <span class="mod-tag">Reply</span>
                            {% elif group.type == 'anonymous' %}
                            <span class="mod-tag">Anon</span>
                            {% elif group.type == 'internal' %}
                            <span class="internal-tag">Internal</span>
                            {% endif %}
                            <span class="chatlog__timestamp">{{ group.created_at }}</span>

                            {% for message in group.messages %}
                                {% if message.content %}
                                <div class="chatlog__content" id="{{ message.id }}">
                                    {{ message.content }}
                                    {% if message.edited %}
                                    <span class="chatlog__edited-timestamp">(edited)</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                                
                                <!-- Attachments -->
                                {% for attachment in message.attachments %}
                                <div class="chatlog__attachment" id="{{ message.id }}">
                                    <a href="{{ attachment.url }}">
                                        {% if attachment.is_image %}
                                        <img class="chatlog__attachment-thumbnail" src="{{ attachment.url }}" alt="Attachment Image"/>
                                        {% else %}
                                        <span>Attachment: {{ attachment.filename | e }}</span>
                                        {% endif %}
                                    </a>
                                </div>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}

                    {% if not log_entry.open %}
                    <div class="chatlog__message-group close">
                        <div class="chatlog__author-avatar-container">
                            <img class="chatlog__author-avatar" src="{{ log_entry.system_avatar_url }}" alt="System Avatar">
                        </div>
                        <div class="chatlog__messages">
                            <span class="chatlog__author-name">{{ log_entry.closer.name | e }}</span>
                            <span class="system-tag">System</span>
                            <span class="chatlog__timestamp">{{ log_entry.human_closed_at | e }}</span>
                            {% if log_entry.close_message %}
                            <div class="chatlog__content">{{ log_entry.close_message }}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Script for Message Interaction -->
    <script>
        function hoverIt(elem) {
            const children = elem.querySelectorAll('.chatlog__content, .chatlog__attachment');
            if (children.length > 0) {
                const shouldAdd = !elem.classList.contains('perma_hover');
                removePermaHover();
                if (shouldAdd) {
                    history.pushState(null, null, '#' + children[0].id);
                    elem.classList.add('perma_hover');
                }
            }
        }

        function highlightMessage() {
            const messageId = window.location.hash.substring(1);
            const msg = document.getElementById(messageId);
            if (msg) {
                const group = msg.closest('.chatlog__message-group');
                group.classList.add('perma_hover');
                return group;
            }
        }

        function removePermaHover() {
            document.querySelectorAll('.perma_hover').forEach(elem => elem.classList.remove('perma_hover'));
            history.pushState(null, null, window.location.href.split('#')[0]);
        }

        window.onhashchange = highlightMessage;

        function toggleInternalMessages() {
            const messages = document.querySelectorAll('.internal');
            messages.forEach(m => m.style.display = (m.style.display === 'none') ? 'flex' : 'none');
        }

        document.addEventListener('DOMContentLoaded', () => {
            highlightMessage();
        });
    </script>

    <!-- Materialize Initialization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        M.AutoInit();
        $('.dropdown-trigger').dropdown({ coverTrigger: false });
    </script>

</body>
</html>
